---
title: "Phenotype Analysis"
author: "David LeBauer, Craig Willis"
date: "`r Sys.Date()`"
output: md_document
---

<!-- note: all edits should be done to the .Rmd source code version of this document, not the .md version which is generated when the Rmd file is compiled -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(jsonlite)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(traits)
```


## BETYdb

BETYdb stores trait data and agronomic metadata. An introduction to the API is in ../betydb.md

Also see the full documentation for accessing data from BETYdb. 


```{r traits}
terraref_betyurl <- "https://terraref.ncsa.illinois.edu/bety/"
mykey = readLines(con = file('~/.betykey'))
site <- betydb_site(id = 6000000866, betyurl = terraref_betyurl, key = mykey)

sorghum <- betydb_search(query = 'Sorghum', 
                         betyurl = terraref_betyurl, 
                         key = mykey) %>% 
  select(author, date, scientificname, cultivar, entity, trait, mean, units, city, sitename)

head(sorghum)

```

### Danfoth Phenotyping Facility 
```{r danforth, fig.width=2, fig.height=5}
danforth <- sorghum %>% 
  filter(author == 'Fahlgren, Noah') %>% 
  mutate(date = lubridate::ymd(date))
  

ggplot(data = danforth, aes(x = date, y = mean, color = cultivar)) +
  #geom_line(aes(y = mean, group = entity), alpha = 0.1) +
  geom_smooth() +
  geom_point(alpha = 0.1, size = 0.5) +
  facet_wrap(~trait, scales = 'free', ncol = 1)
```